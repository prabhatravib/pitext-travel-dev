<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PiText ‚Äì Travel (Voice Enabled)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/static/PiText_favicon.ico" />

  <!---- core styles ---->
  <link rel="stylesheet" href="/static/css/base.css" />
  <link rel="stylesheet" href="/static/css/map.css" />
  <link rel="stylesheet" href="/static/css/controls.css" />
  <link rel="stylesheet" href="/static/css/panel.css" />
  <link rel="stylesheet" href="/static/css/chat.css" />
  <link rel="stylesheet" href="/static/css/vad.css" />
</head>

<body>
  <!---- map canvas ---->
  <div id="map">
    <div class="loading">
      <p>üó∫Ô∏è Ready to plan your trip?</p>
      <p><small>Enter a city & days, then click <em>Start Planning</em>.</small></p>
    </div>
  </div>

  <!---- voice status indicator ---->
  <div id="voice-status" class="voice-status">
    <div class="voice-circle">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <path d="M12 2a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V6a4 4 0 0 1 4-4z"/>
      </svg>
    </div>
    <span class="status-text">Initializing‚Ä¶</span>
  </div>

  <!---- single mic button ---->
  <button id="mic-btn" class="mic-btn" title="Click to start voice chat" style="display: none;">
    <svg viewBox="0 0 24 24" width="24" height="24">
      <path d="M12 2a4 4 0 0 1 4 4v6a4 4 0 1 1-8 0V6a4 4 0 0 1 4-4z"/>
      <path d="M19 10a7 7 0 0 1-14 0"/>
      <path d="M12 19v4M8 23h8"/>
    </svg>
  </button>

  <!---- side-chat & controls ---->
  <aside id="chat-panel" class="chat-panel" aria-live="polite"></aside>

  <div id="panel">
    <button id="minimize-btn" title="Minimize/Expand">‚àí</button>
    <div id="inner-panel">
      <div id="day-controls"></div>
      <form id="trip-form">
        <input id="city"  type="text"     placeholder="Enter city name" value="Paris" required />
        <input id="days"  type="number"   min="1" max="14" value="3"     required />
        <button type="submit">Start Planning</button>
      </form>
    </div>
  </div>

  <div id="map-overlay"></div>

  <!--‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  JS SECTION  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-->

  <!-- 0Ô∏è‚É£  Socket.IO (local ‚Üí CDN fallback) -->
  <script>
    (function loadSocketIO () {
      function trySrc (src, done) {
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload  = () => done(typeof io !== 'undefined');
        s.onerror = () => done(false);
        document.head.appendChild(s);
      }
      trySrc('/socket.io/socket.io.js', ok => {
        if (ok) return console.log('[IO] loaded locally');
        console.warn('[IO] local failed ‚Äì trying CDN');
        trySrc('https://cdn.socket.io/4.7.4/socket.io.min.js', ok2 => {
          if (!ok2) {
            console.error('[IO] failed everywhere ‚Äì voice disabled');
            document.getElementById('voice-status').style.display = 'none';
          } else console.log('[IO] loaded from CDN');
        });
      });
    })();
  </script>

  <!-- 1Ô∏è‚É£  Core utilities -->
  <script src="/static/js/utils/constants.js"></script>
  <script src="/static/js/utils/helpers.js"></script>

  <!-- 2Ô∏è‚É£  API + UI layers -->
  <script src="/static/js/api/config.js"></script>
  <script src="/static/js/api/client.js"></script>
  <script src="/static/js/ui/overlays.js"></script>
  <script src="/static/js/ui/panel.js"></script>
  <script src="/static/js/ui/form.js"></script>
  <script src="/static/js/ui/voice_ui.js"></script>

  <!-- 3Ô∏è‚É£  Google Maps + map helpers -->
  <script src="/static/js/map/google-maps.js"></script>
  <script async src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>

  <script>
    /* map helper loader (parallel is okay here) */
    window.loadMapModules = () => {
      const list = [
        '/static/js/map/markers.js',
        '/static/js/map/routes.js',
        '/static/js/map/controls.js'
      ];
      let done = 0;
      list.forEach(src => {
        const s = document.createElement('script');
        s.src = src;
        s.onload  = () => (++done === list.length) && (
          window.mapModulesReady = true,
          console.log('[MAP] all modules loaded'),
          window.pendingRender && (window.TravelApp.renderTripOnMap(window.pendingRender),
                                   window.pendingRender = null)
        );
        s.onerror = () => console.error('[MAP] failed:', src);
        document.head.appendChild(s);
      });
    };
  </script>

  <!-- 4Ô∏è‚É£  Voice Components -->
  <script src="/static/js/realtime/audio_capture.js"></script>
  <script src="/static/js/realtime/audio_player.js"></script>
  <script src="/static/js/realtime/voice_state_machine.js"></script>
  <script src="/static/js/realtime/websocket_client.js"></script>
  <script src="/static/js/realtime/realtime_controller.js"></script>
  <script src="/static/js/chat.js"></script>

  <!-- 5Ô∏è‚É£  Main application bootstrap -->
  <script src="/static/js/app.js"></script>

  <!-- 6Ô∏è‚É£  Voice initialization -->
<script>
    // Voice initialization using the VoiceUIController
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for all components to load
      setTimeout(() => {
        console.log('Checking for voice components...');
        if (window.RealtimeController && window.VoiceUIController) {
          console.log('Initializing voice UI controller...');
          window.voiceUI = new VoiceUIController();
          window.voiceUI.initialize().then(() => {
            console.log('Voice UI ready');
            // Force show the button again in case CSS is still overriding
            const btn = document.getElementById('mic-btn');
            if (btn) {
              btn.style.display = 'flex';
              console.log('Mic button should now be visible');
            }
          }).catch(err => {
            console.error('Voice UI failed to initialize:', err);
          });
        } else {
          console.error('Required voice components not loaded:', {
            RealtimeController: !!window.RealtimeController,
            VoiceUIController: !!window.VoiceUIController
          });
          
          // Hide voice elements if components failed to load
          document.getElementById('voice-status').style.display = 'none';
          document.getElementById('mic-btn').style.display = 'none';
        }
      }, 2000); // Increased timeout
    });
</script>
  <!-- 7Ô∏è‚É£  Debug helper -->
  <script>
    window.addEventListener('load', () =>
      setTimeout(() => console.log('[DEBUG]', {
        socketIO: !!window.io,
        realtimeController: !!window.RealtimeController,
        voiceUI: !!window.voiceUI
      }), 3000));
  </script>

  <!-- CSS fixes for mic button -->
  <style>
    .mic-btn {
      position: fixed !important;
      right: 1rem !important;
      bottom: 1rem !important;
      width: 56px !important;
      height: 56px !important;
      border-radius: 50% !important;
      background: #4CAF50 !important;
      color: white !important;
      border: none !important;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
      cursor: pointer !important;
      z-index: 10025 !important;
      display: none; /* Remove !important so JS can override */
      align-items: center !important;
      justify-content: center !important;
      transition: all 0.3s ease !important;
    }

    .mic-btn:hover:not(.disabled) {
      background: #45a049 !important;
      transform: scale(1.1) !important;
    }

    .mic-btn.active {
      background: #f44336 !important;
      animation: pulse-recording 1.5s infinite !important;
    }

    .mic-btn.disabled {
      background: #9e9e9e !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
    }

    .mic-btn.ready {
      background: #4CAF50 !important;
      animation: pulse-ready 2s infinite !important;
    }

    @keyframes pulse-recording {
      0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
      100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    @keyframes pulse-ready {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
</style>
    .mic-btn:hover {
      background: #45a049 !important;
      transform: scale(1.1) !important;
    }

    .mic-btn.active {
      background: #f44336 !important;
      animation: pulse-recording 1.5s infinite !important;
    }

    .mic-btn.disabled {
      background: #9e9e9e !important;
      cursor: not-allowed !important;
      opacity: 0.6 !important;
    }

    .mic-btn.ready {
      background: #4CAF50 !important;
      animation: pulse-ready 2s infinite !important;
    }

    @keyframes pulse-recording {
      0% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
      70% { box-shadow: 0 0 0 20px rgba(244, 67, 54, 0); }
      100% { box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
    }

    @keyframes pulse-ready {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
  </style>
</body>
</html>